import{l as je,a as ve,c as O,r as m,u as J,p as ne,b as we,d as K,j as s,D as ye,e as Ce,f as be,g as Ne,B as ee,F as ae,P as Se,h as Me,i as F,k as Ee,m as se,I as ke,n as Te,S as oe,o as ce,q as Ie,C as Ue,E as _e,s as te,t as Re,v as De,w as Ae,x as Pe,y as G,z as Q,A as Le,G as $e,R as Fe,H as Be,Q as Oe,J as He,K as We}from"./vendor-C4ZMoTAN.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=r(a);fetch(a.href,n)}})();let Y=localStorage.getItem("token");const P={getToken:()=>Y,setToken:e=>{Y=e,e?localStorage.setItem("token",e):localStorage.removeItem("token")},clearToken:()=>{Y=null,localStorage.removeItem("token")}},v=je("http://localhost:8080/messages",{autoConnect:!1,extraHeaders:{token:`${P.getToken()}`}}),_=()=>{const e=P.getToken();if(!e){console.error("❌ No token available. Cannot connect to the socket.");return}v.connected||(v.io.opts.extraHeaders={token:e},v.connect(),v.on("connect",()=>console.log("✅ Socket connected successfully.")),v.on("connect_error",t=>console.error("❌ Connection error:",t)),v.on("disconnect",t=>console.warn("⚠️ Socket disconnected:",t)))},q=e=>{v.connected||_(),v.emit("join_chat",{chat_id:e})},Ye=(e,t)=>{v.connected||_(),v.emit("create_message",{chat_id:e,content:t})},ie=(e,t,r)=>{v.connected||_(),v.emit("find_many_messages",{chat_id:e,page_size:t,page_num:r})},qe=(e,t,r)=>{v.connected||_(),v.emit("update_message",{chat_id:e,id:t,is_read:r})},ze=(e,t,r,o)=>{v.connected||_(),v.emit("update_message",{chat_id:e,id:t,content:r,is_read:o})},Ke=(e,t)=>{v.emit("delete_message",{chat_id:e,id:t})},Ge=e=>{v.on("new_message",e)},Qe=e=>{v.off("new_message",e)},le=e=>{v.on("find_many_messages",e)},de=e=>{v.off("find_many_messages",e)},Ve=e=>{v.on("updated_message",e)},Xe=e=>{v.off("updated_message",e)},Ze=e=>{v.on("deleted_message",e)},Je=e=>{v.off("deleted_message",e)},ue=()=>{v.connected&&v.disconnect()},es=async e=>(e.response?.status===401&&(console.error("Unauthorized: Incorrect username or password."),P.clearToken(),ue()),Promise.reject(e)),k=ve.create({baseURL:"http://localhost:3000/v1",headers:{"Content-Type":"application/json"}});k.interceptors.request.use(e=>{const t=P.getToken();return t&&(e.headers.Authorization=`Bearer ${t}`),e},e=>(console.error("Request error:",e),Promise.reject(e)));k.interceptors.response.use(e=>e,async e=>e.response?.status===401?es(e):Promise.reject(e));const ss="/chats",ts=async e=>{try{return(await k.post(`${ss}/${e}`)).data.id}catch(t){const r=t;throw console.error("Error in CreateChat:",r.message||"Unknown error"),new Error(`Error in CreateChat: ${r.message}`)}},rs="/chats",ns=async e=>{try{return(await k.get(`${rs}/${e}`)).data}catch(t){const r=t;throw console.error("Failed to get chats:",r||"Unknown error"),new Error(`Failed to get chats: ${r.message}`)}},as="/chats",os=async()=>{try{return(await k.get(as)).data.data}catch(e){const t=e;throw console.error("Failed to retrieve chats:",t||"Unknown error"),new Error(`Failed to retrieve chats: ${t.message}`)}},cs="/users",is=async()=>{try{return(await k.get(cs)).data.data}catch(e){const t=e;throw console.error("Error fetching users:",t.message||"Unknown error"),new Error(`Error fetching users:' ${t.message}`)}},V=O(e=>({selectedUser:null,chatId:null,setSelectedUser:t=>e({selectedUser:t}),setChatId:t=>e({chatId:t})})),ls=()=>{const[e,t]=m.useState("messages"),[r,o]=m.useState({}),{selectedUser:a,setSelectedUser:n,setChatId:c}=V(),{data:u,isLoading:h}=J({queryKey:["chats"],queryFn:os,enabled:e==="messages"}),{data:p,isLoading:g}=J({queryKey:["users"],queryFn:is,enabled:e==="users"}),j=e==="messages"?h:g,y=()=>e==="messages"?u||[]:p||[];return m.useEffect(()=>{if(!u)return;const l=(i,f)=>{if(i.length>0){const x=i[i.length-1].content;o(d=>({...d,[f]:x}))}};u.forEach(i=>{q(i.id),ie(i.id,1,1);const f=x=>l(x,i.id);return le(f),()=>{de(f)}})},[u]),{activeTab:e,setActiveTab:t,getRenderContent:y,isLoading:j,handleItemClickUsers:async l=>{if(a?.id!==l.id){n(l);try{const i=await ts(l.id);c(i),q(i)}catch(i){console.error("❌ Error creating or joining chat:",i.message||"Unknown error")}}},handleItemClickChats:async l=>{if(l!==a?.id)try{await ns(l),l?(c(l),q(l)):console.error("Failed to fetch chat data.")}catch(i){console.error("Error fetching or joining chat:",i.message||"Unknown error")}},lastMessages:r}},ds="/chats",us=async e=>{try{await k.delete(`${ds}/${e}`)}catch(t){console.log(t);const r=t;throw console.error("Error in delete chat:",r.message||"Unknown error"),new Error(`Error in delete chat: ${r.message}`)}},L=O()(ne(e=>({user:null,setUser:t=>e({user:t}),login:(t,r)=>e({user:{id:t,username:r}}),logout:()=>e({user:null})}),{name:"auth-storage"})),ms=e=>{const[t,r]=m.useState(!1),o=m.useRef(null),a=m.useRef(!0),n=()=>{o.current&&(o.current.scrollTop=o.current.scrollHeight)},c=()=>{o.current&&(o.current.style.scrollBehavior="smooth",n(),setTimeout(()=>{o.current&&(o.current.style.scrollBehavior="auto")},400))},u=m.useCallback(()=>{if(!o.current)return;const{scrollTop:p,scrollHeight:g,clientHeight:j}=o.current;a.current=p+j>=g-10},[]),h=m.useCallback(()=>{if(u(),o.current){const{scrollTop:p,scrollHeight:g,clientHeight:j}=o.current;g-p-j>150?r(!0):r(!1)}},[u]);return m.useEffect(()=>{const p=o.current;if(p)return p.addEventListener("scroll",h),()=>{p.removeEventListener("scroll",h)}},[h]),m.useEffect(()=>{a.current&&n()},[e]),{containerRef:o,scrollToBottom:n,handleSmoothScroll:c,showScrollButton:t}},me=()=>{const[e,t]=m.useState([]),[r,o]=m.useState(0),{selectedUser:a,chatId:n}=V(),{user:c}=L(),{containerRef:u,scrollToBottom:h,handleSmoothScroll:p,showScrollButton:g}=ms(e),j=m.useCallback(()=>e.filter(i=>Number(i.is_read)===0&&i.sender_id!==c?.id).length,[e,c?.id]);m.useEffect(()=>{if(!n)return;const i=f=>{t(f)};return ie(n,20,1),le(i),()=>{de(i)}},[n]),m.useEffect(()=>{const i=f=>{t(x=>x.some(d=>d.id===f.id)?x:[...x,f])};return Ge(i),()=>{Qe(i)}},[n,c?.id]);const y=m.useCallback(()=>n?new IntersectionObserver(f=>{f.forEach(x=>{const d=x.isIntersecting,N=x.target,C=N.getAttribute("data-id"),E=N.classList.contains("mine"),S=e.find(U=>U.id===Number(C));d&&C&&!E&&S&&S.initiator_id!==c?.id&&qe(n,Number(C),!0)})},{threshold:1}):console.log(n),[n,e,c?.id]);m.useEffect(()=>{if(e.length===0)return;const i=y();if(!i)return;const f=u.current;if(!f)return;const x=f.querySelectorAll(".message[data-id]");return x.forEach(d=>{i.observe(d)}),()=>{x.forEach(d=>i.unobserve(d))}},[e,y,u]);const b=m.useCallback(i=>{n&&ze(n,i.id,i.content,!!i.is_read)},[n]);m.useEffect(()=>{const i=f=>{f.chat_id===n&&(t(x=>x.map(d=>d.id===f.id?{...d,content:f.content??d.content,is_read:f.is_read??d.is_read}:d)),o(j()))};return Ve(i),()=>{Xe(i)}},[n,j]);const w=m.useCallback(i=>{n&&Ke(n,i.id)},[n]);return m.useEffect(()=>{const i=f=>{t(x=>{const d=x.findIndex(N=>N.id===f.id);return d===-1?x:[...x.slice(0,d),...x.slice(d+1)]})};return Ze(i),()=>{Je(i)}},[n,c?.id]),{selectedUser:a,messages:e,handleSend:i=>{!i.trim()||!n||!c||(Ye(n,i),setTimeout(()=>{h()},0))},user:c,containerRef:u,unreadMessagesLen:r,handleSmoothScroll:p,showScrollButton:g,deleteMessage:w,updateMessages:b}},X=e=>{const{deleteMessage:t,updateMessages:r}=me(),o=we(),[a,n]=m.useState(!1),[c,u]=m.useState("content"in e&&e.content||""),h=m.useRef(null),p=K({mutationFn:async d=>us(d),onSuccess:()=>o.invalidateQueries({queryKey:["chats"]})}),g=async()=>{if("content"in e&&e.content)try{await navigator.clipboard.writeText(e.content)}catch(d){console.error(d)}},j=()=>{"content"in e&&t(e)},y=d=>{"content"in e&&e.content&&r({...e,content:d})},b=()=>{"id"in e&&p.mutate(e.id)},w=d=>{d&&"content"in e&&(n(!0),setTimeout(()=>{if(h.current){const N=h.current.value.length;h.current.setSelectionRange(N,N),h.current.focus()}},0))},l=d=>{u(d.target.value),x()},i=()=>{if("content"in e){const d=c.trimEnd();d&&d!==e.content?.trimEnd()&&y(d)}n(!1)},f=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),i())},x=()=>{h.current&&(h.current.style.height="20px",h.current.style.width="auto",h.current.style.height=`${h.current.scrollHeight}px`,h.current.style.maxWidth="100%")};return m.useEffect(()=>{a&&x()},[a]),{handleCopyMessage:g,handleDeleteMessages:j,handleUpdateMessages:y,startEditing:w,handleInputChange:l,finishEditing:i,handleKeyDown:f,isEditing:a,editedContent:c,textareaRef:h,deleteChat:b}},he=({visible:e,x:t,y:r,onClose:o,items:a})=>{const n=m.useRef(null);return m.useEffect(()=>{const c=u=>{n.current&&!n.current.contains(u.target)&&o()};return e&&document.addEventListener("mousedown",c),()=>{document.removeEventListener("mousedown",c)}},[e,o]),e?s.jsx("div",{ref:n,className:"contextMenu",style:{top:`${r}px`,left:`${t}px`},children:s.jsx("ul",{children:a.map((c,u)=>c.type==="divider"?s.jsx("hr",{},u):s.jsxs("li",{className:c.className,onClick:()=>{c.onClick&&c.onClick(),o()},style:{"--index":u},children:[c.icon&&s.jsx("span",{className:"menuIcon",children:c.icon}),c.text]},u))})}):null},B=({open:e,onClose:t,onConfirm:r,message:o,confirmText:a,cancelText:n,title:c})=>s.jsxs(ye,{open:e,onClose:t,sx:{"& .MuiPaper-root":{maxWidth:"300px",backgroundColor:"var(--main-color)",color:"var(--text-color)",textAlign:"center",fontSize:"16px",padding:"15px"}},children:[s.jsx(Ce,{sx:{fontFamily:"`Inter`, sans-serif",padding:"10px 0px",fontSize:"16px"},children:c}),s.jsx(be,{sx:{color:"var(--text-color)",padding:"5px 0px",fontSize:"14px"},children:s.jsx("p",{children:o})}),s.jsxs(Ne,{sx:{display:"flex",alignItems:"center",justifyContent:"space-around",borderRadius:"10px",padding:"10px 0px"},children:[s.jsx(ee,{sx:{border:"1px solid var(--button-auth)",color:"var(--button-auth)",borderRadius:"15px",padding:"5px 13px",fontSize:"16px",textTransform:"none","&:hover":{border:"1px solid var(--button-auth-hov)",color:"var(--button-auth-hov)"}},onClick:t,children:n}),s.jsx(ee,{sx:{border:"1px solid transparent",backgroundColor:"var(--error-color)",color:"var(--stable-light-color)",padding:"5px 13px",borderRadius:"15px",fontSize:"16px",textTransform:"none"},onClick:r,children:a})]})]}),re=({data:e,onClick:t,isActive:r,lastMessage:o,activeTab:a})=>{const n=()=>l({visible:!1,x:0,y:0}),{deleteChat:c}=X(e),u=C=>C.username!==void 0,p=((C,E=35)=>C.length>E?C.slice(0,E)+"...":C)(o||" "),g="https://github.com/KR1470R/artos-messenger/blob/main/assets/fallbackAvatar.png?raw=true",[j,y]=m.useState(u(e)?e.avatar_url:g),b=()=>y(g),[w,l]=m.useState({visible:!1,x:0,y:0}),[i,f]=m.useState(!1),x=C=>{if(a!=="messages")return;C.preventDefault();const S=C.currentTarget.closest(".conversationList")?.getBoundingClientRect(),U=150,R=100;let D=C.clientX-(S?.left||0),M=C.clientY-(S?.top||0);const T=D+U<S.width,I=M+R<S.height;T||(D-=U),I||(M-=R),l({visible:!0,x:D,y:M})},d=()=>{c(),f(!1)},N=[{type:"action",icon:s.jsx(ae,{}),text:"Delete Chat",onClick:()=>f(!0),className:"menuItemDelete"}];return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:`conversationListItem ${r?"active":""}`,onClick:t,onContextMenu:x,children:[s.jsx("img",{className:"conversationPhoto",src:j,alt:"conversation",onError:b}),s.jsxs("div",{className:"conversationInfo",children:[s.jsx("h1",{className:"conversationTitle",children:u(e)?e.username:`Chat #${e.id}`}),s.jsx("p",{className:"conversationSnippet",children:p})]})]}),s.jsx(he,{visible:w.visible,x:w.x,y:w.y,onClose:n,items:N}),s.jsx(B,{open:i,onClose:()=>f(!1),onConfirm:d,message:"Are you sure you want to delete the chat?",confirmText:"Delete",cancelText:"Cancel",title:"Artos Messenger"})]})},hs=({activeTab:e,setActiveTab:t})=>s.jsxs("div",{className:"tabs",children:[s.jsx("div",{className:`tab ${e==="messages"?"active":""}`,onClick:()=>t("messages"),children:"Messages"}),s.jsx("div",{className:`tab ${e==="users"?"active":""}`,onClick:()=>t("users"),children:"Users"})]}),H=O(e=>({tabMain:"chats",activeParam:null,setTabMain:t=>e({tabMain:t}),setActiveParam:t=>e({activeParam:t})})),ge=()=>{const{tabMain:e,setTabMain:t}=H();return s.jsxs("div",{className:"tabsMain",children:[s.jsx("div",{className:`tabMain ${e==="chats"?"active":""}`,onClick:()=>t("chats"),children:s.jsx(Se,{})}),s.jsx("div",{className:`tabMain ${e==="settings"?"active":""}`,onClick:()=>t("settings"),children:s.jsx(Me,{})})]})},$=({title:e,leftItems:t,rightItems:r})=>s.jsxs("div",{className:"toolbar",children:[s.jsx("div",{className:"leftItems",children:t}),s.jsx("h1",{className:"toolbarTitle",children:e}),s.jsx("div",{className:"rightItems",children:r})]}),Z=({icon:e,onClick:t})=>s.jsx("i",{className:`toolbarButton ${e}`,onClick:t,role:"button",tabIndex:0}),gs=()=>s.jsx("div",{className:"conversationSearch",children:s.jsx("input",{type:"search",className:"conversationSearchInput",placeholder:"Search Messages"})}),ps=()=>{const{activeTab:e,setActiveTab:t,getRenderContent:r,isLoading:o,handleItemClickUsers:a,handleItemClickChats:n,lastMessages:c}=ls(),{chatId:u,selectedUser:h}=V(),p=r();return s.jsxs("div",{className:"conversationList",children:[s.jsx($,{title:"Artos Messenger",leftItems:[],rightItems:[s.jsx(Z,{icon:"ion-ios-add-circle-outline"},"add")]}),s.jsx(gs,{}),s.jsx(hs,{activeTab:e,setActiveTab:t}),o?s.jsx("div",{className:"loading",children:"Loading..."}):s.jsx("div",{className:"content",children:e==="messages"?p.map(g=>s.jsx(re,{data:g,isActive:u===g.id,activeTab:e,lastMessage:c[g.id],onClick:()=>n(g.id)},g.id)):p.map(g=>s.jsx(re,{data:g,activeTab:e,isActive:h?.id===g.id,onClick:()=>a({id:g.id,username:g.username})},g.id))}),s.jsx(ge,{})]})},fs=({data:e})=>{const[t,r]=m.useState({visible:!1,x:0,y:0}),{startEditing:o,handleInputChange:a,finishEditing:n,handleKeyDown:c,isEditing:u,editedContent:h,textareaRef:p}=X(e),g=F().startOf("day"),j=F(e.created_at),y=j.isSame(g,"day"),b=!j.isSame(g,"year"),w=y?"Today":b?j.format("D MMMM, YYYY"):j.format("D MMMM"),l=j.format("HH:mm");return{handleContextMenu:x=>{x.preventDefault();const N=x.currentTarget.closest(".messageList")?.getBoundingClientRect(),C=150,E=100;let S=x.clientX-(N?.left||0),U=x.clientY-(N?.top||0);const R=S+C<N.width,D=U+E<N.height;R||(S-=C),D||(U-=E),r({visible:!0,x:S,y:U})},displayDate:w,isEditing:u,messageDate:j,textareaRef:p,editedContent:h,handleInputChange:a,finishEditing:n,handleKeyDown:c,messageTime:l,contextMenu:t,closeContextMenu:()=>r({visible:!1,x:0,y:0}),startEditing:o}},xs=({data:e,isMine:t,showDate:r})=>{const{handleCopyMessage:o,handleDeleteMessages:a}=X(e),[n,c]=m.useState(!1),u=()=>{a(),c(!1)},h=L(S=>S.user),{handleContextMenu:p,displayDate:g,isEditing:j,messageDate:y,textareaRef:b,editedContent:w,handleInputChange:l,finishEditing:i,handleKeyDown:f,messageTime:x,contextMenu:d,closeContextMenu:N,startEditing:C}=fs({data:e}),E=h?.id===e.sender_id?[{type:"action",icon:s.jsx(Ee,{}),text:"Edit",onClick:()=>C(t)},{type:"action",icon:s.jsx(se,{}),text:"Copy Text",onClick:o},{type:"divider"},{type:"action",icon:s.jsx(ae,{}),text:"Delete",onClick:()=>c(!0),className:"menuItemDelete"}]:[{type:"action",icon:s.jsx(se,{}),text:"Copy Text",onClick:o}];return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:["message",t?"mine":""].join(" "),"data-id":e.id,onContextMenu:p,children:[r&&s.jsx("div",{className:"timestamp",children:s.jsx("div",{children:g})}),s.jsx("div",{className:"bubbleContainer",children:s.jsxs("div",{className:"bubble",title:y.format("HH:mm D MMMM, YYYY"),children:[j?s.jsx("textarea",{ref:b,className:"editTextarea",value:w,onChange:l,onBlur:i,onKeyDown:f,autoFocus:!0}):s.jsx("span",{className:"bubbleMessageContent",children:e.content}),s.jsxs("span",{className:"messageTime",children:[x,t&&s.jsx("span",{className:"messageStatus",children:e.is_read?s.jsx(ke,{}):s.jsx(Te,{})})]})]})})]}),s.jsx(he,{visible:d.visible,x:d.x,y:d.y,onClose:N,items:E}),s.jsx(B,{open:n,onClose:()=>c(!1),onConfirm:u,message:"Delete selected message?",confirmText:"Delete",cancelText:"Cancel",title:"Artos Messenger"})]})},js=({onSend:e})=>{const[t,r]=m.useState(""),o=()=>{t.trim()&&(e(t),r(""))};return s.jsxs("div",{className:"compose",children:[s.jsx("input",{type:"text",className:"composeInput",placeholder:"Write a message...",value:t,onChange:a=>r(a.target.value),onKeyUp:a=>a.key==="Enter"&&o()}),s.jsx("span",{onKeyDown:a=>a.key==="Enter"&&o,children:s.jsx(Z,{icon:"ion-ios-send",onClick:o},"send")})]})},vs=()=>{const{selectedUser:e,messages:t,handleSend:r,user:o,containerRef:a,unreadMessagesLen:n,handleSmoothScroll:c,showScrollButton:u}=me();let h=null;return s.jsxs("div",{className:"messageList",children:[s.jsx($,{title:`Chat with ${e?.username||"..."}`,leftItems:[],rightItems:[s.jsx(Z,{icon:"ion-ios-information-circle-outline"},"info")]}),s.jsx("div",{className:"messageListContainer",ref:a,children:t.map(p=>{const g=F(p.created_at).format("YYYY-MM-DD"),j=g!==h;return h=g,s.jsx(xs,{data:p,isMine:p.initiator_id===o?.id||p.sender_id===o?.id,showDate:j},p.id)})}),u&&s.jsxs("div",{className:"scrollBut",onClick:c,children:[n>0&&s.jsx("span",{className:"messageLen",children:n}),s.jsx("div",{className:"scrollBot",children:s.jsx(oe,{})})]}),s.jsx(js,{onSend:r})]})},A={USERNAME:/^[a-zA-Zа-яА-ЯёЁЇїІіЄєҐґ0-9_\-!@#$%^&*()]{3,20}$/,PASSWORD:/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*?&]{6,20}$/,AVATAR_URL:/^https?:\/\/.*\.(jpg|jpeg|png|gif)$/i},ws="/users/me",ys=async()=>{try{const e=await k.delete(ws);return console.log(e),e.data}catch(e){const t=e;throw console.error("Error delete user:",t.message),new Error(`Error delete user: ${t.message}`)}},Cs="/users/me",bs=async e=>{try{return(await k.patch(Cs,e)).data}catch(t){const r=t;throw console.error("Error Patch user:",r.message),new Error(`Error Patch user: ${r.message}`)}},Ns=()=>{const{user:e,setUser:t,logout:r}=L(),[o,a]=m.useState(!1),[n,c]=m.useState({old_password:!1,new_password:!1}),[u,h]=m.useState(!1),[p,g]=m.useState(!1),[j,y]=m.useState(null),[b,w]=m.useState(null),{register:l,handleSubmit:i,formState:{isSubmitting:f,errors:x},reset:d,watch:N}=ce({mode:"onChange",defaultValues:{username:e?.username||"",avatar_url:e?.avatar_url||"",old_password:"",password:""}}),C=async M=>{M.old_password||M.password?(y(M),g(!0)):await E(M)},E=async M=>{const T=Object.fromEntries(Object.entries(M).filter(([I])=>!["id","last_login_at","created_at","updated_at"].includes(I)));try{await bs(T);const I={...e,...T,id:e?.id??0,username:T.username??e?.username??"",avatar_url:T.avatar_url??e?.avatar_url??""};t(I),d({...I,old_password:"",password:""}),w({message:"Profile updated successfully!",type:"success"})}catch(I){let W="Failed to update profile.";I?.response?.data?.message?W=`Error: ${I.response.data.message}`:I?.message&&(W=`Error: ${I.message}`),w({message:W,type:"error"})}},S=async()=>{j&&(await E(j),y(null)),g(!1)},U=N("avatar_url",e?.avatar_url),R=async()=>{try{await ys(),r(),w({message:"Account deleted successfully!",type:"success"})}catch(M){let T="Failed to delete account.";M?.response?.data?.message?T=`Error: ${M.response.data.message}`:M?.message&&(T=`Error: ${M.message}`),w({message:T,type:"error"})}};return{handleSubmit:i,onSubmit:C,avatarUrl:U,register:l,errors:x,showPasswordFields:o,setShowPasswordFields:a,showPassword:n,setShowPassword:c,passwordWarning:p,setPasswordWarning:g,deleteWarning:u,setDeleteWarning:h,isSubmitting:f,confirmDeleteMe:()=>{R(),h(!1)},confirmPasswordUpdate:S,notification:b,setNotification:w,user:e}},pe=({message:e,type:t,open:r,onClose:o})=>{const[a,n]=m.useState(!1),[c,u]=m.useState(!1),h=m.useRef(null),p=()=>clearTimeout(h.current),g=()=>j(),j=m.useCallback(()=>{clearTimeout(h.current),h.current=setTimeout(()=>{u(!1),setTimeout(o,500)},3e3)},[o]);return m.useEffect(()=>(r?(u(!0),j()):u(!1),()=>clearTimeout(h.current)),[r,j]),s.jsx(Ie,{open:c,onClose:o,autoHideDuration:null,anchorOrigin:{vertical:"top",horizontal:"right"},className:`notification-container ${c?"show":"hide"}`,children:s.jsxs("div",{className:`notification ${t==="success"?"success":"error"}`,onMouseEnter:p,onMouseLeave:g,children:[s.jsx("div",{className:"icon",children:t==="success"?s.jsx(Ue,{className:"success-icon"}):s.jsx(_e,{className:"error-icon"})}),s.jsx("div",{className:`message ${a?"expanded":""}`,children:a?e:`${e.slice(0,30)}${e.length>30?"...":""}`}),s.jsxs("div",{className:"actions",children:[e.length>30&&s.jsx(te,{size:"small",onClick:()=>n(!a),children:a?s.jsx(Re,{}):s.jsx(De,{})}),s.jsx(te,{size:"small",onClick:o,children:s.jsx(Ae,{})})]})]})})},Ss=()=>{const{handleSubmit:e,onSubmit:t,avatarUrl:r,register:o,errors:a,showPasswordFields:n,setShowPasswordFields:c,showPassword:u,setShowPassword:h,passwordWarning:p,setPasswordWarning:g,deleteWarning:j,setDeleteWarning:y,isSubmitting:b,confirmDeleteMe:w,confirmPasswordUpdate:l,notification:i,setNotification:f,user:x}=Ns();return s.jsxs(s.Fragment,{children:[s.jsx($,{title:"Profile",leftItems:[],rightItems:[]}),s.jsxs("div",{className:"profileContainer",children:[s.jsxs("form",{onSubmit:e(t),className:"profile-form",children:[s.jsxs("div",{className:"personalData",children:[s.jsx("div",{className:"personalImage",children:s.jsx("img",{src:r,alt:"User avatar"})}),s.jsxs("div",{className:"personalInput",children:[s.jsxs("p",{className:"nameInput",children:[s.jsx("input",{...o("username",{pattern:{value:A.USERNAME,message:"Username should be between 3 and 20 characters long and contain only letters, digits, and special characters."}}),placeholder:"Enter new username"}),a.username&&s.jsx("span",{className:"inputError",children:a.username.message})]}),s.jsx("hr",{}),s.jsxs("p",{className:"urlInput",children:[s.jsx("input",{...o("avatar_url",{pattern:{value:A.AVATAR_URL,message:"Please enter a valid avatar URL (e.g. .jpg, .jpeg, .png, .gif)."}}),placeholder:"Enter avatar URL"}),a.avatar_url&&s.jsx("span",{className:"inputError",children:a.avatar_url.message})]})]})]}),s.jsxs("p",{className:"changePasswordText",onClick:()=>c(!n),children:[n?"Hide password fields":"Change password",s.jsx("span",{children:n?s.jsx(Pe,{}):s.jsx(oe,{})})]}),s.jsxs("div",{className:`passwordFields ${n?"open":""}`,children:[s.jsxs("p",{className:"passwordInput",children:[s.jsx("input",{type:u.old_password?"text":"password",...o("old_password"),placeholder:"Enter old password"}),s.jsx("span",{className:"eyeIcon",onClick:()=>h(d=>({...d,old_password:!d.old_password})),children:u.old_password?s.jsx(G,{}):s.jsx(Q,{})})]}),s.jsx("hr",{}),s.jsxs("p",{className:"passwordInput",children:[s.jsx("input",{type:u.new_password?"text":"password",...o("password",{pattern:{value:A.PASSWORD,message:"Password should be between 6 and 20 characters and contain at least one letter and one number."}}),placeholder:"Enter new password"}),s.jsx("span",{className:"eyeIcon",onClick:()=>h(d=>({...d,new_password:!d.new_password})),children:u.new_password?s.jsx(G,{}):s.jsx(Q,{})}),a.password&&s.jsx("span",{className:"inputError",children:a.password.message})]})]}),s.jsx("button",{className:"submitButton",type:"submit",disabled:b,children:b?"Updating...":"Update"})]}),s.jsx("button",{className:"deleteMe",onClick:()=>y(!0),children:"Delete me"})]}),s.jsx(B,{open:p,onClose:()=>g(!1),onConfirm:l,message:"You are changing your password. Are you sure you want to proceed?",confirmText:"Confirm",cancelText:"Cancel",title:"Password Change Warning"}),s.jsx(B,{open:j,onClose:()=>y(!1),onConfirm:w,message:"Are you sure you want to delete your account?",confirmText:"Delete",cancelText:"Cancel",title:x?.username}),i&&s.jsx(pe,{message:i.message,type:i.type,open:!!i,onClose:()=>f(null)})]})},fe=O()(ne(e=>({activeTheme:"darkTheme",setActiveTheme:t=>{const r=t==="systemTheme"?window.matchMedia("(prefers-color-scheme: dark)").matches?"darkTheme":"lightTheme":t;e({activeTheme:t}),document.body.className=r}}),{name:"theme-storage"})),Ms=()=>{const{setActiveTheme:e}=fe();return s.jsxs(s.Fragment,{children:[s.jsx($,{title:"Themes",leftItems:[],rightItems:[]}),s.jsxs("div",{className:"themeSwitcher",children:[s.jsxs("div",{className:"themeItem",onClick:()=>e("lightTheme"),children:[s.jsx("img",{src:"/lightTheme.png",alt:"Day Mode"}),s.jsx("p",{className:"nameMode",children:"Day"})]}),s.jsxs("div",{className:"themeItem",onClick:()=>e("darkTheme"),children:[s.jsx("img",{src:"/darkTheme.png",alt:"Night Mode"}),s.jsx("p",{className:"nameMode",children:"Night"})]}),s.jsxs("div",{className:"themeItem",onClick:()=>e("systemTheme"),children:[s.jsx("img",{src:"/systemTheme.png",alt:"System Mode"}),s.jsx("p",{className:"nameMode",children:"System"})]})]})]})},Es=()=>{const e=H(t=>t.activeParam);return e==="profile"?s.jsx(Ss,{}):e==="themes"?s.jsx(Ms,{}):null},z=({param:e,text:t,colorIcon:r,icon:o,onClick:a})=>{const{activeParam:n,setActiveParam:c}=H(),u=()=>{c(e),a&&a()};return s.jsx("div",{className:`settingsParam ${n===e?"active":""}`,onClick:u,children:s.jsxs("p",{className:"paramItem",children:[s.jsx("span",{className:"icon",style:{backgroundColor:r},children:s.jsx(o,{})}),t]})})},ks=()=>{const{user:e,logout:t}=L(),r=F(e?.created_at).format("D.MM.YYYY HH:mm:ss"),o=()=>{t(),document.cookie.split(";").forEach(a=>{const[n]=a.split("=");document.cookie=`${n.trim()}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${window.location.hostname}`})};return s.jsxs("div",{className:"settingsList",children:[s.jsx($,{title:"Settings",leftItems:[],rightItems:[]}),s.jsxs("div",{className:"settingsUser",children:[s.jsx("p",{className:"avatar",children:s.jsx("img",{src:e?.avatar_url,alt:"avatar_url"})}),s.jsxs("div",{className:"contentUser",children:[s.jsx("p",{className:"username",children:e?.username}),s.jsxs("p",{className:"dataCreate",children:["Created: ",r]}),s.jsxs("p",{className:"dataId",children:["ID: ",e?.id]})]})]}),s.jsx(z,{param:"profile",text:"My Profile",colorIcon:"#ca213d",icon:Le}),s.jsx(z,{param:"themes",text:"Color Theme",colorIcon:"#1e94f9",icon:$e}),s.jsx("div",{className:"logoutContainer",children:s.jsx(z,{param:"logout",text:"Log Out",colorIcon:"#ca213d",icon:Fe,onClick:o})}),s.jsx(ge,{})]})},Ts="/users/register",Is=async e=>{try{const{data:t}=await k.post(Ts,e,{headers:{"Content-Type":"application/json"}});return t}catch(t){const r=t;throw console.error("Registration failed:",r||"Unknown error"),new Error(`Registration failed: ${r}`)}},Us="/users/me",xe=async()=>{try{const t=(await k.get(Us)).data;L.getState().setUser(t)}catch(e){const t=e;throw console.error("Error fetching user data:",t.message),new Error(`Error fetching user data: ${t.message}`)}},_s="/auth/sign-in",Rs=async e=>{try{const t=await k.post(_s,e),{token:r}=t.data;P.setToken(r),await xe()}catch(t){const r=t;throw new Error(`Sign-in failed, please check credentials. ${r.message}`)}},Ds=()=>{const[e,t]=m.useState("login"),r=e==="login",[o,a]=m.useState(!1),[n,c]=m.useState(""),{register:u,handleSubmit:h,reset:p,watch:g,formState:{errors:j}}=ce({mode:"onChange",defaultValues:{username:"",password:"",avatar_url:""}}),{mutateAsync:y}=K({mutationKey:["register"],mutationFn:Is,onError:l=>{console.error("Error during registration:",l),c(l.message)},onSuccess:async()=>{try{const{username:l,password:i}=g();await b({username:l,password:i})}catch(l){console.error("Sign-in failed after registration:",l),c(`Sign-in failed after registration: ${l}`)}}}),{mutateAsync:b}=K({mutationKey:["login"],mutationFn:Rs,onError:l=>{l.statusCode===401?(console.error("Login error: Invalid credentials provided."),c("Invalid username or password.")):(console.error("Login error: Unexpected server issue.",l),c(`Login error: Unexpected server issue. ${l}`))},onSuccess:async()=>{try{await xe(),_()}catch(l){console.error("Error fetching user data after login:",l),c("Failed to retrieve user data after login.")}}}),w=async l=>{try{c(""),r?await b({username:l.username,password:l.password}):await y(l),p()}catch(i){console.error("Error during submission:",i),c(`Error during submission: ${i}`)}};return m.useEffect(()=>{const l=P.getToken();return l&&(v.io.opts.extraHeaders={Authorization:`Bearer ${l}`},_()),()=>{ue()}},[]),{handleSubmit:h(w),isAuthType:r,register:l=>{switch(l){case"username":return u(l,{required:"Username is required",pattern:{value:A.USERNAME,message:"Username must be 3-20 characters and contain only letters, numbers, underscores, or dashes"}});case"password":return u(l,{required:"Password is required",pattern:{value:A.PASSWORD,message:"Password must be 6-20 characters, include at least one letter and one number"}});case"avatar_url":return u(l,{required:r?void 0:"Avatar URL is required for registration",pattern:{value:A.AVATAR_URL,message:"Avatar URL must be a valid image link (jpg, jpeg, png, gif)"}});default:return u(l)}},setType:t,errors:j,showPassword:o,setShowPassword:a,errorMessage:n,setErrorMessage:c}},As=()=>{const{handleSubmit:e,isAuthType:t,register:r,setType:o,errors:a,showPassword:n,setShowPassword:c,errorMessage:u,setErrorMessage:h}=Ds();return s.jsxs("div",{className:"wrapper",children:[s.jsxs("form",{onSubmit:e,className:"formSignIn",children:[s.jsx("h2",{className:"formSignInHeading",children:t?"Login":"Registration"}),s.jsx("div",{className:"formGroup",children:s.jsx("input",{type:"text",className:`formControl ${a.username?"formError":""}`,placeholder:"User name",...r("username")})}),s.jsxs("div",{className:"formGroup",children:[s.jsx("input",{type:n?"text":"password",className:`formControl ${a.password?"formError":""}`,placeholder:"Password",...r("password")}),s.jsx("span",{className:"eyeIcon",onClick:()=>c(!n),children:n?s.jsx(G,{}):s.jsx(Q,{})})]}),!t&&s.jsx("div",{className:"formGroup",children:s.jsx("input",{type:"text",className:`formControl ${a.avatar_url?"formError":""}`,placeholder:"Avatar URL",...r("avatar_url")})}),s.jsxs("div",{onClick:()=>o(t?"register":"login"),className:"btn_register",children:["I want to ",t?"Register":"Login"]}),s.jsx("button",{className:"btn_login",type:"submit",children:t?"Login":"Register"}),Object.keys(a).length>0&&s.jsx("div",{className:"errorContainer",children:Object.values(a).map((p,g)=>s.jsx("p",{className:"errorText",children:p.message},g))})]}),s.jsx(pe,{message:u,type:"error",open:!!u,onClose:()=>h("")})]})},Ps=()=>{const e=L(r=>r.user),t=H(r=>r.tabMain);return e?s.jsx("div",{className:"messenger",children:t==="chats"?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"scrollable sidebar",children:s.jsx(ps,{})}),s.jsx("div",{className:"scrollable content",children:s.jsx(vs,{})})]}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"scrollable sidebar",children:s.jsx(ks,{})}),s.jsx("div",{className:"scrollable content",children:s.jsx(Es,{})})]})}):s.jsx(As,{})},Ls=()=>{const{activeTheme:e}=fe();return m.useEffect(()=>{const t=()=>{const r=e==="systemTheme"?window.matchMedia("(prefers-color-scheme: dark)").matches?"darkTheme":"lightTheme":e;document.body.className=r};if(t(),e==="systemTheme"){const r=window.matchMedia("(prefers-color-scheme: dark)");return r.addEventListener("change",t),()=>{r.removeEventListener("change",t)}}},[e]),s.jsx("div",{className:"App",children:s.jsx(Ps,{})})},$s=Be.createRoot(document.getElementById("root")),Fs=new Oe;$s.render(s.jsx(He.StrictMode,{children:s.jsx(We,{client:Fs,children:s.jsx(Ls,{})})}));
